var t=(e,s,o)=>new Promise((f,g)=>{var p=n=>{try{a(o.next(n))}catch(u){g(u)}},h=n=>{try{a(o.throw(n))}catch(u){g(u)}},a=n=>n.done?f(n.value):Promise.resolve(n.value).then(p,h);a((o=o.apply(e,s)).next())});import{E as i,I as S,u as _}from"./vendor.f2b32264.js";import{r as y}from"./index.e11613a4.js";const l=i({url:"frappe.auth.get_logged_user",cache:"User",onError(e){e&&e.exc_type==="AuthenticationError"&&y.push({name:"LoginPage"})}});function c(){let s=new URLSearchParams(document.cookie.split("; ").join("&")).get("user_id");return s==="Guest"&&(s=null),s}function d(){r.user=null,localStorage.removeItem("selectedLoginRole"),localStorage.removeItem("userRoles"),localStorage.removeItem("user"),localStorage.removeItem("session_id"),localStorage.removeItem("logout_clicked_timestamp")}const r=S({login:i({url:"school.al_ummah.api2.login",makeParams({email:e,password:s,role:o}){return{usr:e,pwd:s,role:o||"System User"}},onSuccess(e){return t(this,null,function*(){if(console.log("Login successful:",e),e&&e.status==="success")l.reload(),r.user=c(),r.login.reset(),e.roles&&localStorage.setItem("userRoles",JSON.stringify(e.roles)),window.dispatchEvent(new CustomEvent("login-success",{detail:e}));else{const s=e.message||"Login failed. Please try again.";console.warn("Login failed:",s)}})},onError(e){console.error("Login failed:",e)}}),verifyOtp:i({url:"school.al_ummah.api2.verify_otp_and_create_session",makeParams({phone:e,otp:s,role:o}){return{phone:e,otp:s,role:o||"Instructor"}},onSuccess(e){return t(this,null,function*(){if(console.log("OTP verified successfully:",e),e.status==="success")console.log("OTP login successful, session created on backend"),localStorage.setItem("user",JSON.stringify({username:e.user,role:e.role||"teacher",roles:e.roles})),e.roles&&localStorage.setItem("userRoles",JSON.stringify(e.roles)),r.user=c(),l&&l.reload(),window.dispatchEvent(new CustomEvent("otp-verification-success",{detail:e}));else{const s=e.message||"OTP verification failed. Please try again.";console.warn("OTP verification failed:",s)}})},onError(e){console.error("Error verifying OTP:",e)}}),verifyGoogleToken:i({url:"school.al_ummah.api2.verify_google_token_and_create_session",makeParams({id_token:e,role:s}){return{id_token:e,role:s||"Instructor"}},onSuccess(e){return t(this,null,function*(){if(console.log("Google token verified successfully:",e),e.success)console.log("Google authentication successful, session created on backend"),localStorage.setItem("user",JSON.stringify({username:e.user,email:e.email,role:e.role||"teacher",roles:e.roles})),e.roles&&localStorage.setItem("userRoles",JSON.stringify(e.roles)),e.sid&&localStorage.setItem("session_id",e.sid),r.user=c(),l&&l.reload(),window.dispatchEvent(new CustomEvent("google-auth-success",{detail:e}));else{const s=e.error||"Google authentication failed. Please try again.";console.warn("Google authentication failed:",s)}})},onError(e){console.error("Error verifying Google token:",e)}}),logout:i({url:"logout",onSuccess(){l.reset(),r.user=c(),d()},onError(e){console.error("Logout failed:",e),r.user=null,d()}}),user:c(),isLoggedIn:_(()=>!!r.user)});function E(e){localStorage.setItem("selectedLoginRole",e),console.log("Role saved to localStorage:",e)}function k(){return localStorage.getItem("selectedLoginRole")||""}const m={CLIENT_ID:"619580422153-9o7kvuuocsjfqejuv2jrud3h986t5prc.apps.googleusercontent.com",initialize:(e,s="teacher")=>{if(typeof window=="undefined"||!window.google)return console.log("Google API not loaded yet"),!1;try{return window.google.accounts.id.initialize({client_id:m.CLIENT_ID,callback:o=>m.handleCredentialResponse(o,s),auto_select:!1,cancel_on_tap_outside:!0,ux_mode:"popup"}),window.google.accounts.id.renderButton(document.getElementById(e),{theme:"outline",size:"large",width:280,text:"signin_with",shape:"pill",logo_alignment:"center"}),console.log("Google Sign-In initialized successfully"),!0}catch(o){return console.error("Error initializing Google Sign-In:",o),!1}},handleCredentialResponse:(e,s)=>t(void 0,null,function*(){try{console.log("Google credential response received",e),console.log("Current role:",s);const o=s==="parent"?"Guardian":"Instructor";console.log("Sending role to API:",o),yield r.verifyGoogleToken.submit({id_token:e.credential,role:o})}catch(o){console.error("Error handling credential response:",o)}}),loadScript:()=>new Promise((e,s)=>{if(document.getElementById("google-js-sdk")){e();return}const o=document.createElement("script");o.id="google-js-sdk",o.src="https://accounts.google.com/gsi/client",o.async=!0,o.defer=!0,o.onload=()=>{setTimeout(()=>{e()},100)},o.onerror=()=>{console.error("Failed to load Google Sign-In script"),s(new Error("Failed to load Google Sign-In"))},document.head.appendChild(o)})};export{d as clearAuthData,k as getSelectedLoginRole,m as googleAuth,r as session,c as sessionUser,E as setSelectedLoginRole};
