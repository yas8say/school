var we=Object.defineProperty,Se=Object.defineProperties;var ke=Object.getOwnPropertyDescriptors;var te=Object.getOwnPropertySymbols;var _e=Object.prototype.hasOwnProperty,Ce=Object.prototype.propertyIsEnumerable;var ae=(v,l,d)=>l in v?we(v,l,{enumerable:!0,configurable:!0,writable:!0,value:d}):v[l]=d,B=(v,l)=>{for(var d in l||(l={}))_e.call(l,d)&&ae(v,d,l[d]);if(te)for(var d of te(l))Ce.call(l,d)&&ae(v,d,l[d]);return v},ne=(v,l)=>Se(v,ke(l));var H=(v,l,d)=>new Promise((s,N)=>{var S=c=>{try{u(d.next(c))}catch(E){N(E)}},n=c=>{try{u(d.throw(c))}catch(E){N(E)}},u=c=>c.done?s(c.value):Promise.resolve(c.value).then(S,n);u((d=d.apply(v,l)).next())});import{_ as Ne,r as p,y as Ee,j as z,k as Re,c as r,b as a,l as U,t as C,f as I,g as q,F as M,h as Y,i as xe,n as Fe,o as i,v as Me}from"./index-AyqD_6TW.js";import{u as A,r as Ye}from"./xlsx-CZX1Z_DZ.js";const De={setup(){const v=p([]),l=Ee(()=>v.value.map((e,t)=>({original:e,display:t===0?`${e} - Current Year`:e}))),d=p(null),s=p([]),N=p([]),S=p(null),n=p(null),u=p([]),c=p(null),E=p(["First Name","Middle Name","Last Name","Email Address","Phone Number","GR Number","Roll No","Guardian Name","Guardian Number","Guardian Email","Relation"]),G=p(null),R=p([]),T=p([]),P=p([]),_=p([]),K=p(!1),Z=p(!1),J=p(""),X=z({url:"school.al_ummah.api3.get_academic_years",params:{values:{}},onSuccess:e=>{v.value=Array.isArray(e)?e:[],v.value.length>0&&(d.value=v.value[0]),v.value.length||f("No academic years available","error")},onError:e=>{var t;console.error("Error fetching academic years:",e),v.value=[],f(`Error fetching academic years: ${((t=e.messages)==null?void 0:t[0])||"Unknown error"}`,"error")}}),$=z({url:"school.al_ummah.api3.get_classes",params:{values:{}},onSuccess:e=>{s.value=Array.isArray(e)?e:[],console.log("Classes loaded:",s.value),s.value.length||f("No classes available","error")},onError:e=>{var t;console.error("Error fetching classes:",e),s.value=[],f(`Error fetching classes: ${((t=e.messages)==null?void 0:t[0])||"Unknown error"}`,"error")}}),Q=z({url:"school.al_ummah.api3.get_divisions2",params:{values:{classId:S.value,academicYear:d.value}},onSuccess:e=>{N.value=Array.isArray(e)?e:[],console.log("Divisions loaded:",N.value)},onError:e=>{var t;console.error("Error fetching divisions:",e),N.value=[],f(`Error fetching divisions: ${((t=e.messages)==null?void 0:t[0])||"Unknown error"}`,"error")}}),j=z({url:"school.al_ummah.api3.bulk_enroll_students",params:{academicYear:d.value,className:S.value,divisionName:n.value,students:[],mappings:{}},onSuccess:()=>{Z.value=!0,J.value="",K.value=!0,_.value=[]},onError:e=>{var t;console.error("Error enrolling students:",e),Z.value=!1,J.value=((t=e.messages)==null?void 0:t[0])||"Unexpected error during enrollment",K.value=!0}});Re(()=>{X.reload(),$.reload()});function oe(){S.value=null,n.value=null,N.value=[],ee()}function ee(){n.value=null,N.value=[],S.value&&d.value&&(Q.update({params:{values:{classId:S.value,academicYear:d.value}}}),Q.reload())}function re(e){let t="";for(;e>=0;)t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26)-1;return t}function ie(){return H(this,null,function*(){const e=document.createElement("input");e.type="file",e.accept=".xlsx,.xls,.csv",e.onchange=t=>H(this,null,function*(){const m=t.target.files[0];if(m){c.value=m,f(null);try{const{data:h,headers:g}=yield me(m);R.value=h.slice(0,100),T.value=g,u.value=g.map((o,w)=>({type:null,column:A.encode_col(w)})),ce(g)}catch(h){console.error("Error loading preview:",h),f("Error loading file preview","error")}}}),e.click()})}function de(){c.value=null,R.value=[],T.value=[],u.value=[],P.value=[],_.value=[],f(null)}function le(e,t=null){let m=e;t!==null&&(m=[e[t]]);const g=m.map(o=>{const w={"First Name":"","Middle Name":"","Last Name":"",Name:"","Email Address":"","Phone Number":"","GR Number":"","Roll No":"","Guardian Name":"","Guardian Number":"",Relation:"","Guardian Email":""};return u.value.forEach(({type:k,column:b})=>{var L;if(k)try{const D=A.decode_col(b),O=T.value[D],y=((L=o[O])==null?void 0:L.toString().trim())||"";w[k]=y}catch(D){console.error(`Error mapping column ${b} for type ${k}:`,D)}}),w}).filter(o=>Object.values(o).some(w=>w!==""));return B({academicYear:d.value,className:S.value,divisionName:n.value,students:g},E.value.reduce((o,w)=>{const k=u.value.find(b=>b.type===w);return o[w]=k?k.column:"None",o},{}))}function ue(){return H(this,null,function*(){console.log("Enroll button clicked");const e=["First Name","GR Number","Last Name","Roll No"],t=u.value.map(o=>o.type).filter(o=>o),m=e.filter(o=>!t.includes(o));if(m.length>0){const o=`Please map the following required fields: ${m.join(", ")}`;console.error(o),f(o,"error");return}if(u.value.filter(o=>o.type&&(!o.column||!/^[A-Z]+$/.test(o.column))).length>0){f("Please check your column mappings - some are invalid","error");return}if(!d.value||!S.value||!n.value){const o="Please select an academic year, class, and division";console.error(o),f(o,"error");return}if(!c.value){const o="Please select a file first";console.error(o),f(o,"error");return}if(R.value.length===0){f("No data available to enroll","error");return}const g=le(R.value);console.log("Sending updated preview data to enrollStudents:",g),j.update({params:{academicYear:d.value,className:S.value,divisionName:n.value,students:g.students,mappings:B({},g)}}),j.submit()})}function ce(e){const t={"First Name":["first","fname","given"],"Last Name":["last","lname","surname"],"Middle Name":["middle","mname"],"Email Address":["email","mail"],"Phone Number":["phone","mobile","contact"],"GR Number":["gr","grno","gr_num"],"Roll No":["roll","rollno","roll_num"],"Guardian Name":["guardian","parent","father","mother"],"Guardian Number":["guardian phone","parent phone","father phone","mother phone","guardian mobile"],Relation:["relation","relationship"],"Guardian Email":["guardian email","parent email","father email","mother email"]};e.forEach((m,h)=>{if(!m)return;const g=m.toLowerCase();for(const[o,w]of Object.entries(t))if(w.some(k=>g.includes(k))){u.value[h].type=o;break}}),console.log("Auto-detected mappings:",u.value)}function me(e){return new Promise((t,m)=>{const h=new FileReader;h.onload=g=>{try{const o=new Uint8Array(g.target.result),w=Ye(o,{type:"array",sheetStubs:!0}),k=w.Sheets[w.SheetNames[0]],b=A.decode_range(k["!ref"]);let L=0;for(let y=b.s.r;y<=b.e.r;++y){let x=!1;for(let V=b.s.c;V<=b.e.c;++V){const F=k[A.encode_cell({c:V,r:y})];if(F&&F.v!==void 0&&F.v!==null&&F.v!==""){x=!0;break}}if(x){L=y;break}}const D=[];for(let y=b.s.c;y<=b.e.c;++y){const x=k[A.encode_cell({c:y,r:L})];D.push(x?String(x.v).trim():`Column ${y+1}`)}const O=[];for(let y=L+1;y<=b.e.r;++y){const x={};let V=!1;for(let F=b.s.c;F<=b.e.c;++F){const W=k[A.encode_cell({c:F,r:y})],se=D[F-b.s.c];x[se]=W?W.v===void 0?"":W.v:"",x[se]!==""&&(V=!0)}V&&O.push(x)}t({data:O,headers:D})}catch(o){m(o)}},h.onerror=g=>m(g),h.readAsArrayBuffer(e)})}function ve(e,t,m){u.value[e]=ne(B({},u.value[e]),{[t]:m,column:A.encode_col(e)})}function ge(e){R.value.splice(e,1),P.value=P.value.filter(t=>t.rowIndex!==e),_.value=_.value.filter(t=>t.rowIndex!==e),f("Row deleted","success")}function f(e,t="info"){G.value=e?{text:e,type:t}:null,e&&t!=="error"&&t!=="success"&&setTimeout(()=>f(null),5e3)}function fe(e,t,m){const g=R.value[e][t]||"";if(g!==m){const o={rowIndex:e,column:t,oldValue:g,newValue:m,timestamp:new Date().toISOString()};P.value.push(o),_.value.push(o),console.log("Cell edit recorded:",o),he()}}function pe(e,t){let m;return function(...h){clearTimeout(m),m=setTimeout(()=>e.apply(this,h),t)}}const he=pe(be,500);function be(){return H(this,null,function*(){if(_.value.length!==0)try{const e=_.value[_.value.length-1],t=le(R.value,e.rowIndex);console.log("Sending cell update via enrollStudents:",t),j.update({params:{academicYear:d.value,className:S.value,divisionName:n.value,students:t.students,mappings:B({},t)}}),j.submit()}catch(e){console.error("Error sending cell update:",e),f(`Failed to save cell update: ${e.message||"Unknown error"}`,"error")}})}function ye(){const e=P.value.pop();if(e){const{rowIndex:t,column:m,oldValue:h}=e;R.value[t][m]=h,_.value=_.value.filter(g=>g!==e),f("Last edit undone","success")}else f("No edits to undo","info")}return{academicYears:v,displayYears:l,selectedYear:d,classes:s,divisions:N,selectedClass:S,selectedDivision:n,mappings:u,fileSelected:c,options:E,message:G,previewData:R,previewHeaders:T,editHistory:P,pendingEdits:_,academicYearsResource:X,classesResource:$,divisionsResource:Q,enrollStudentsResource:j,showResultMessage:K,submitSuccess:Z,errorMessage:J,onYearChange:oe,onClassChange:ee,getExcelColumnLetter:re,handleFileSelection:ie,removeFile:de,handleEnrollStudents:ue,updateMapping:ve,deleteRow:ge,showMessage:f,handleCellEdit:fe,undoLastEdit:ye}}},Ue={class:"scroll-view-content"},Ae={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},Ge={key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},Pe={class:"bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center"},Le={key:0,class:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100"},Ve={key:1,class:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"},je={class:"mt-3 text-lg font-medium text-gray-900"},Be={class:"mt-2 text-sm text-gray-500"},He={class:"mt-5"},Ie={class:"white-card"},Te=["disabled"],Oe=["value"],ze=["disabled"],qe=["value"],Ke={key:0,class:"card-title"},Ze=["disabled"],Je=["value"],Qe={class:"white-card"},We={key:0,class:"file-selected"},Xe={class:"button-text"},$e={class:"white-card"},el=["disabled"],ll={key:0,class:"button-text"},sl={key:1,class:"button-text"},tl={key:2,class:"white-card preview-card"},al={class:"table-container"},nl={class:"preview-table"},ol=["onUpdate:modelValue","onChange"],rl=["value"],il={class:"header-label"},dl={class:"actions"},ul=["onClick"],cl=["onUpdate:modelValue","onInput","placeholder"];function ml(v,l,d,s,N,S){return i(),r("div",Ue,[l[24]||(l[24]=a("h1",{class:"title"},"Students Enrollment Screen",-1)),s.enrollStudentsResource.loading?(i(),r("div",Ae,l[9]||(l[9]=[a("div",{class:"bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center"},[a("div",{class:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"}),a("h3",{class:"text-lg font-medium text-gray-900"},"Submitting your data..."),a("p",{class:"mt-2 text-sm text-gray-500"},"Please wait while we process your information.")],-1)]))):U("",!0),s.showResultMessage?(i(),r("div",Ge,[a("div",Pe,[s.submitSuccess?(i(),r("div",Le,l[10]||(l[10]=[a("svg",{class:"h-6 w-6 text-green-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})],-1)]))):(i(),r("div",Ve,l[11]||(l[11]=[a("svg",{class:"h-6 w-6 text-red-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))),a("h3",je,C(s.submitSuccess?"Students Enrolled Successfully!":"Enrollment Failed"),1),a("p",Be,C(s.submitSuccess?"Students have been successfully enrolled.":s.errorMessage||"An error occurred while enrolling students."),1),a("div",He,[a("button",{onClick:l[0]||(l[0]=n=>s.showResultMessage=!1),class:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"}," OK ")])])])):U("",!0),a("div",Ie,[l[15]||(l[15]=a("h2",{class:"card-title"},"Select a Year",-1)),I(a("select",{"onUpdate:modelValue":l[1]||(l[1]=n=>s.selectedYear=n),class:"picker2",onChange:l[2]||(l[2]=(...n)=>s.onYearChange&&s.onYearChange(...n)),disabled:s.academicYearsResource.loading},[l[12]||(l[12]=a("option",{value:null},"Select a Year",-1)),(i(!0),r(M,null,Y(s.displayYears,n=>(i(),r("option",{key:n,value:n.original},C(n.display),9,Oe))),128))],40,Te),[[q,s.selectedYear]]),l[16]||(l[16]=a("h2",{class:"card-title"},"Class / Program",-1)),I(a("select",{"onUpdate:modelValue":l[3]||(l[3]=n=>s.selectedClass=n),class:"picker2",onChange:l[4]||(l[4]=(...n)=>s.onClassChange&&s.onClassChange(...n)),disabled:!s.selectedYear||s.classesResource.loading},[l[13]||(l[13]=a("option",{value:null},"Select a Class / Program",-1)),(i(!0),r(M,null,Y(s.classes,n=>(i(),r("option",{key:n.name,value:n.name},C(n.name),9,qe))),128))],40,ze),[[q,s.selectedClass]]),s.divisions.length>0?(i(),r("h2",Ke,"Division / Student Group")):U("",!0),s.divisions.length>0?I((i(),r("select",{key:1,"onUpdate:modelValue":l[5]||(l[5]=n=>s.selectedDivision=n),class:"picker2",disabled:!s.selectedClass||s.divisionsResource.loading},[l[14]||(l[14]=a("option",{value:null},"Select a Division / Student Group",-1)),(i(!0),r(M,null,Y(s.divisions,n=>(i(),r("option",{key:n.name,value:n.name},C(n.name),9,Je))),128))],8,Ze)),[[q,s.selectedDivision]]):U("",!0)]),a("div",Qe,[l[17]||(l[17]=a("h2",{class:"card-title"},"Upload Student Data",-1)),s.fileSelected?(i(),r("div",We,[a("span",null,"Selected file: "+C(s.fileSelected.name),1),a("button",{onClick:l[6]||(l[6]=(...n)=>s.removeFile&&s.removeFile(...n)),class:"remove-file-btn"},"×")])):U("",!0),a("button",{class:"button",onClick:l[7]||(l[7]=(...n)=>s.handleFileSelection&&s.handleFileSelection(...n))},[a("span",Xe,C(s.fileSelected?"Change File":"Upload File 📤"),1)])]),a("div",$e,[a("button",{class:"button",onClick:l[8]||(l[8]=(...n)=>s.handleEnrollStudents&&s.handleEnrollStudents(...n)),disabled:s.enrollStudentsResource.loading||!s.selectedYear||!s.selectedClass||!s.selectedDivision||!s.fileSelected},[s.enrollStudentsResource.loading?(i(),r("span",ll,l[18]||(l[18]=[a("span",{class:"spinner"},null,-1),xe(" Processing... ")]))):(i(),r("span",sl,"Enroll Students ✅"))],8,el),s.message&&!s.showResultMessage?(i(),r("div",{key:0,class:Fe(["message",s.message.type])},C(s.message.text),3)):U("",!0)]),s.fileSelected&&s.previewData.length>0?(i(),r("div",tl,[l[23]||(l[23]=a("h2",{class:"card-title"},"File Preview (First 100 rows)",-1)),a("div",al,[a("table",nl,[a("thead",null,[a("tr",null,[l[19]||(l[19]=a("th",{class:"actions"},"Actions",-1)),(i(!0),r(M,null,Y(s.previewHeaders,(n,u)=>(i(),r("th",{key:"letter-"+u},C(s.getExcelColumnLetter(u)),1))),128))]),a("tr",null,[l[21]||(l[21]=a("th",{class:"actions"},null,-1)),(i(!0),r(M,null,Y(s.previewHeaders,(n,u)=>(i(),r("th",{key:"header-"+u},[I(a("select",{"onUpdate:modelValue":c=>s.mappings[u].type=c,class:"table-select",onChange:c=>s.updateMapping(u,"type",c.target.value)},[l[20]||(l[20]=a("option",{value:null},"Select Field",-1)),(i(!0),r(M,null,Y(s.options,(c,E)=>(i(),r("option",{key:E,value:c},C(c),9,rl))),128))],40,ol),[[q,s.mappings[u].type]]),a("span",il,C(n),1)]))),128))])]),a("tbody",null,[(i(!0),r(M,null,Y(s.previewData,(n,u)=>(i(),r("tr",{key:u},[a("td",dl,[a("button",{onClick:c=>s.deleteRow(u),class:"trash-icon2"},l[22]||(l[22]=[a("span",{class:"icon"},"❎",-1)]),8,ul)]),(i(!0),r(M,null,Y(s.previewHeaders,(c,E)=>(i(),r("td",{key:E},[I(a("input",{"onUpdate:modelValue":G=>n[c]=G,class:"table-input",onInput:G=>s.handleCellEdit(u,c,G.target.value),placeholder:n[c]||"-"},null,40,cl),[[Me,n[c]]])]))),128))]))),128))])])])])):U("",!0)])}const pl=Ne(De,[["render",ml],["__scopeId","data-v-4011d9eb"]]);export{pl as default};
