var ce=Object.defineProperty,de=Object.defineProperties;var ue=Object.getOwnPropertyDescriptors;var z=Object.getOwnPropertySymbols;var me=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var Z=(c,l,p)=>l in c?ce(c,l,{enumerable:!0,configurable:!0,writable:!0,value:p}):c[l]=p,P=(c,l)=>{for(var p in l||(l={}))me.call(l,p)&&Z(c,p,l[p]);if(z)for(var p of z(l))ve.call(l,p)&&Z(c,p,l[p]);return c},H=(c,l)=>de(c,ue(l));var I=(c,l,p)=>new Promise((a,b)=>{var A=t=>{try{d(p.next(t))}catch(k){b(k)}},i=t=>{try{d(p.throw(t))}catch(k){b(k)}},d=t=>t.done?a(t.value):Promise.resolve(t.value).then(A,i);d((p=p.apply(c,l)).next())});import{_ as pe,r as _,j as q,k as fe,c as m,b as s,t as w,l as x,i as he,n as ge,F as U,h as R,o as v,f as j,g as J,v as be}from"./index-YpdTZEFl.js";import{u as M,r as ye}from"./xlsx-CZX1Z_DZ.js";const Ne={setup(){const c=_([]),l=_(null),p=_(["First Name","Middle Name","Last Name","Full Name","Gender","Mobile","Email","Date of Birth","Date of Joining","PAN Number","Bank Name","Bank A/C No.","IFSC Code","Designation","Current Address","Permanent Address","Blood Group","Attendance Device ID (Biometric/RF tag ID)","Qualification (Education)","School/University (Education)"]),a=_(null),b=_([]),A=_([]),i=_([]),d=_([]),t=_([]),k=q({url:"school.al_ummah.api3.get_classes",params:{values:{}},onSuccess:e=>{i.value=Array.isArray(e)?e:[],console.log("Classes loaded:",i.value),i.value.length||f("No classes available","error")},onError:e=>{var n;console.error("Error fetching classes:",e),i.value=[],f(`Error fetching classes: ${((n=e.messages)==null?void 0:n[0])||"Unknown error"}`,"error")}}),B=q({url:"school.al_ummah.api3.get_divisions1",params:{values:{classId:""}},onSuccess:e=>Array.isArray(e)?e:[],onError:e=>{var n;return console.error("Error fetching divisions:",e),f(`Error fetching divisions: ${((n=e.messages)==null?void 0:n[0])||"Unknown error"}`,"error"),[]}}),V=q({url:"school.al_ummah.api3.bulk_enroll_instructors",params:{teachers:[],mappings:{}},onSuccess:e=>{f("✅ Teachers enrolled successfully!","success"),t.value=[]},onError:e=>{var n;console.error("Error enrolling teachers:",e),f(((n=e.messages)==null?void 0:n[0])||"Unexpected error during teacher enrollment","error")}});fe(()=>{k.reload()});function K(e){return I(this,null,function*(){const n=b.value[e];if(n.divisionName=null,n.className)try{B.update({params:{values:{classId:n.className}}});const r=yield B.reload();n.divisions=Array.isArray(r)?r:[],console.log(`Divisions for ${n.className}:`,n.divisions)}catch(r){console.error("Error fetching divisions:",r),f(`Error fetching divisions for ${n.className}`,"error")}else n.divisions=[]})}function W(e){let n="";for(;e>=0;)n=String.fromCharCode(65+e%26)+n,e=Math.floor(e/26)-1;return n}function X(){return I(this,null,function*(){const e=document.createElement("input");e.type="file",e.accept=".xlsx,.xls",e.onchange=n=>I(this,null,function*(){const r=n.target.files[0];if(r){l.value=r,f(null);try{const{data:u,headers:h}=yield le(r);b.value=u.slice(0,100).map(o=>H(P({},o),{className:null,divisionName:null,divisions:[]})),A.value=h,c.value=h.map((o,y)=>({type:null,column:M.encode_col(y)})),Y(h,u.slice(0,5))}catch(u){console.error("Error loading preview:",u),f("Error loading file preview","error")}}}),e.click()})}function Y(e,n){const r={"First Name":["first","fname","given","firstname"],"Middle Name":["middle","mname","midname"],"Last Name":["last","lname","surname","family","lastname"],"Full Name":["full name","name","teacher name"],Email:["email","e-mail","mail"],Mobile:["mobile","phone","cell","contact"],"Date of Birth":["dob","birth","birthdate","date of birth"],Gender:["gender","sex"],"Date of Joining":["doj","joining","start date"],"PAN Number":["pan","pan no","pan number"],"Bank Name":["bank","bank name"],"Bank A/C No.":["account","ac no","bank account","account no"],"IFSC Code":["ifsc","code"],Designation:["designation","position","title","role"],"Current Address":["current address","address","present address"],"Permanent Address":["permanent address","home address"],"Blood Group":["blood","blood group"],"Attendance Device ID (Biometric/RF tag ID)":["attendance id","biometric","rfid","device id"],"Qualification (Education)":["qualification","education","degree"],"School/University (Education)":["school","university","institution"]};e.forEach((u,h)=>{if(!u)return;const o=u.toString().toLowerCase();for(const[y,N]of Object.entries(r))if(N.some(g=>o.includes(g))){c.value[h].type=y;break}}),console.log("Auto-detected mappings:",c.value)}function $(){l.value=null,b.value=[],A.value=[],c.value=[],d.value=[],t.value=[],f(null)}function O(e,n=null){let r=e;n!==null&&(r=[e[n]]);const u=[...b.value],o=r.map((y,N)=>{const g=n!==null?y:N<u.length?u[N]:{},F={"First Name":"","Middle Name":"","Last Name":"","Full Name":"",Gender:"",Mobile:"",Email:"","Date of Birth":"","Date of Joining":"","PAN Number":"","Bank Name":"","Bank A/C No.":"","IFSC Code":"",Designation:"","Current Address":"","Permanent Address":"","Blood Group":"","Attendance Device ID (Biometric/RF tag ID)":"","Qualification (Education)":"","School/University (Education)":"",Class:g.className||"",Division:g.divisionName||""};return c.value.forEach(({type:T,column:L},C)=>{var D;if(T)try{const S=M.decode_col(L),E=A.value[S],G=((D=y[E])==null?void 0:D.toString().trim())||"";F[T]=G}catch(S){console.error(`Error mapping column ${L} for type ${T}:`,S)}}),F}).filter(y=>Object.values(y).some(N=>N!==""));return P({teachers:o},p.value.reduce((y,N)=>{const g=c.value.find(F=>F.type===N);return y[N]=g?g.column:"None",y},{}))}function ee(){return I(this,null,function*(){console.log("Enroll button clicked");const e=["Mobile","Email","Date of Birth","Gender","First Name","Last Name","Attendance Device ID (Biometric/RF tag ID)"],n=c.value.map(o=>o.type).filter(o=>o),r=e.filter(o=>!n.includes(o));if(r.length>0){const o=`Please map the following required fields: ${r.join(", ")}`;console.error(o),f(o,"error");return}if(c.value.filter(o=>o.type&&(!o.column||!/^[A-Z]+$/.test(o.column))).length>0){f("Please check your column mappings - some are invalid","error");return}if(!l.value){const o="Please select a file first";console.error(o),f(o,"error");return}if(b.value.length===0){f("No data available to enroll","error");return}const h=O(b.value);console.log("Sending updated preview data to enrollTeachers:",h),V.update({params:{teachers:h.teachers,mappings:P({},h)}}),V.submit()})}function le(e){return new Promise((n,r)=>{const u=new FileReader;u.onload=h=>{try{const o=new Uint8Array(h.target.result),y=ye(o,{type:"array",sheetStubs:!0}),N=y.Sheets[y.SheetNames[0]],g=M.decode_range(N["!ref"]);let F=0;for(let C=g.s.r;C<=g.e.r;++C){let D=!1;for(let S=g.s.c;S<=g.e.c;++S){const E=N[M.encode_cell({c:S,r:C})];if(E&&E.v!==void 0&&E.v!==null&&E.v!==""){D=!0;break}}if(D){F=C;break}}const T=[];for(let C=g.s.c;C<=g.e.c;++C){const D=N[M.encode_cell({c:C,r:F})];T.push(D?String(D.v).trim():`Column ${C+1}`)}const L=[];for(let C=F+1;C<=g.e.r;++C){const D={};let S=!1;for(let E=g.s.c;E<=g.e.c;++E){const G=N[M.encode_cell({c:E,r:C})],Q=T[E-g.s.c];D[Q]=G?G.v===void 0?"":G.v:"",D[Q]!==""&&(S=!0)}S&&L.push(D)}n({data:L,headers:T})}catch(o){r(o)}},u.onerror=h=>r(h),u.readAsArrayBuffer(e)})}function ne(e,n,r){c.value[e]=H(P({},c.value[e]),{[n]:r,column:M.encode_col(e)})}function te(e){b.value.splice(e,1),d.value=d.value.filter(n=>n.rowIndex!==e),t.value=t.value.filter(n=>n.rowIndex!==e),f("Row deleted","success")}function f(e,n="info"){a.value=e?{text:e,type:n}:null,e&&n!=="error"&&n!=="success"&&setTimeout(()=>f(null),5e3)}function se(e,n,r){const h=b.value[e][n]||"";if(h!==r){const o={rowIndex:e,column:n,oldValue:h,newValue:r,timestamp:new Date().toISOString()};d.value.push(o),t.value.push(o),console.log("Cell edit recorded:",o),oe()}}function ae(e,n){let r;return function(...u){clearTimeout(r),r=setTimeout(()=>e.apply(this,u),n)}}const oe=ae(re,500);function re(){return I(this,null,function*(){if(t.value.length!==0)try{const e=t.value[t.value.length-1],n=O(b.value,e.rowIndex);console.log("Sending cell update via enrollTeachers:",n),V.update({params:{teachers:n.teachers,mappings:P({},n)}}),V.submit()}catch(e){console.error("Error sending cell update:",e),f(`Failed to save cell update: ${e.message||"Unknown error"}`,"error")}})}function ie(){const e=d.value.pop();if(e){const{rowIndex:n,column:r,oldValue:u}=e;b.value[n][r]=u,t.value=t.value.filter(h=>h!==e),f("Last edit undone","success")}else f("No edits to undo","info")}return{mappings:c,fileSelected:l,options:p,message:a,previewData:b,previewHeaders:A,classes:i,editHistory:d,pendingEdits:t,classesResource:k,divisionsResource:B,enrollTeachersResource:V,onClassChange:K,getExcelColumnLetter:W,handleFileSelection:X,removeFile:$,handleEnrollTeachers:ee,updateMapping:ne,deleteRow:te,showMessage:f,handleCellEdit:se,undoLastEdit:ie}}},Ce={class:"scroll-view-content"},De={class:"white-card"},Ee={key:0,class:"file-selected"},ke={class:"button-text"},Se={class:"white-card"},_e=["disabled"],Fe={key:0,class:"button-text"},we={key:1,class:"button-text"},Ae={key:0,class:"table-white-card preview-card"},Be={class:"table-outer-container"},Te={class:"table-scroll-container"},Ue={class:"table-container"},Re={class:"preview-table"},Me=["onUpdate:modelValue","onChange"],Pe=["value"],Ie={class:"header-label"},Ve={class:"actions"},Le=["onClick"],Ge=["onUpdate:modelValue","onChange","disabled"],je=["value"],He=["onUpdate:modelValue","disabled"],qe=["value"],xe=["onUpdate:modelValue","onInput","placeholder"];function Je(c,l,p,a,b,A){return v(),m("div",Ce,[l[16]||(l[16]=s("h1",{class:"title"},"Teacher Enrollment",-1)),s("div",De,[l[3]||(l[3]=s("h2",{class:"card-title"},"Upload Teacher Data",-1)),a.fileSelected?(v(),m("div",Ee,[s("span",null,"Selected file: "+w(a.fileSelected.name),1),s("button",{onClick:l[0]||(l[0]=(...i)=>a.removeFile&&a.removeFile(...i)),class:"remove-file-btn"},"×")])):x("",!0),s("button",{class:"button",onClick:l[1]||(l[1]=(...i)=>a.handleFileSelection&&a.handleFileSelection(...i))},[s("span",ke,w(a.fileSelected?"Change File":"Upload File 📤"),1)])]),s("div",Se,[s("button",{class:"button",onClick:l[2]||(l[2]=(...i)=>a.handleEnrollTeachers&&a.handleEnrollTeachers(...i)),disabled:a.enrollTeachersResource.loading||!a.fileSelected},[a.enrollTeachersResource.loading?(v(),m("span",Fe,l[4]||(l[4]=[s("span",{class:"spinner"},null,-1),he(" Processing... ")]))):(v(),m("span",we,"Enroll Teachers ✅"))],8,_e),a.message?(v(),m("div",{key:0,class:ge(["message",a.message.type])},w(a.message.text),3)):x("",!0)]),a.fileSelected&&a.previewData.length>0?(v(),m("div",Ae,[l[15]||(l[15]=s("h2",{class:"card-title"},"File Preview (First 100 rows)",-1)),s("div",Be,[s("div",Te,[s("div",Ue,[s("table",Re,[s("thead",null,[s("tr",null,[l[5]||(l[5]=s("th",{class:"actions"},"Actions",-1)),l[6]||(l[6]=s("th",null,"Class/Program",-1)),l[7]||(l[7]=s("th",null,"Division/Student Group",-1)),(v(!0),m(U,null,R(a.previewHeaders,(i,d)=>(v(),m("th",{key:"letter-"+d},w(a.getExcelColumnLetter(d)),1))),128))]),s("tr",null,[l[9]||(l[9]=s("th",{class:"actions"},null,-1)),l[10]||(l[10]=s("th",null,"Class/Program",-1)),l[11]||(l[11]=s("th",null,"Division/Student Group",-1)),(v(!0),m(U,null,R(a.previewHeaders,(i,d)=>(v(),m("th",{key:"header-"+d},[j(s("select",{"onUpdate:modelValue":t=>a.mappings[d].type=t,class:"table-select",onChange:t=>a.updateMapping(d,"type",t.target.value)},[l[8]||(l[8]=s("option",{value:null},"Select Field",-1)),(v(!0),m(U,null,R(a.options,(t,k)=>(v(),m("option",{key:k,value:t},w(t),9,Pe))),128))],40,Me),[[J,a.mappings[d].type]]),s("span",Ie,w(i),1)]))),128))])]),s("tbody",null,[(v(!0),m(U,null,R(a.previewData,(i,d)=>(v(),m("tr",{key:d},[s("td",Ve,[s("button",{onClick:t=>a.deleteRow(d),class:"trash-icon2"},l[12]||(l[12]=[s("span",{class:"icon"},"❎",-1)]),8,Le)]),s("td",null,[j(s("select",{"onUpdate:modelValue":t=>i.className=t,class:"table-select",onChange:t=>a.onClassChange(d),disabled:a.classesResource.loading},[l[13]||(l[13]=s("option",{value:null},"Select Class",-1)),(v(!0),m(U,null,R(a.classes,t=>(v(),m("option",{key:t.name,value:t.name},w(t.name),9,je))),128))],40,Ge),[[J,i.className]])]),s("td",null,[j(s("select",{"onUpdate:modelValue":t=>i.divisionName=t,class:"table-select",disabled:!i.className||a.divisionsResource.loading},[l[14]||(l[14]=s("option",{value:null},"Select Division",-1)),(v(!0),m(U,null,R(i.divisions,t=>(v(),m("option",{key:t.name,value:t.name},w(t.name),9,qe))),128))],8,He),[[J,i.divisionName]])]),(v(!0),m(U,null,R(a.previewHeaders,(t,k)=>(v(),m("td",{key:k},[j(s("input",{"onUpdate:modelValue":B=>i[t]=B,class:"table-input",onInput:B=>a.handleCellEdit(d,t,B.target.value),placeholder:i[t]||"-"},null,40,xe),[[be,i[t]]])]))),128))]))),128))])])])])])])):x("",!0)])}const Ze=pe(Ne,[["render",Je],["__scopeId","data-v-465048db"]]);export{Ze as default};
