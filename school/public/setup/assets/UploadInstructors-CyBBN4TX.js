var P=Object.defineProperty,L=Object.defineProperties;var I=Object.getOwnPropertyDescriptors;var U=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var B=(s,e,l)=>e in s?P(s,e,{enumerable:!0,configurable:!0,writable:!0,value:l}):s[e]=l,S=(s,e)=>{for(var l in e||(e={}))H.call(e,l)&&B(s,l,e[l]);if(U)for(var l of U(e))V.call(e,l)&&B(s,l,e[l]);return s},M=(s,e)=>L(s,I(e));var w=(s,e,l)=>new Promise((c,t)=>{var o=i=>{try{r(l.next(i))}catch(h){t(h)}},a=i=>{try{r(l.throw(i))}catch(h){t(h)}},r=i=>i.done?c(i.value):Promise.resolve(i.value).then(o,a);r((l=l.apply(s,e)).next())});import{a as R,d as G,f as T}from"./apiUtils-CCQy72K0.js";import{u as y,r as j}from"./xlsx-CZX1Z_DZ.js";import{_ as x,c as d,b as n,t as b,j as F,i as q,n as J,F as D,h as C,o as u,f as k,g as _,v as O}from"./index-BsE_pyWB.js";const Q={data(){return{mappings:[],fileSelected:null,options:["First Name","Middle Name","Last Name","Full Name","Gender","Mobile","Email","Date of Birth","Date of Joining","PAN Number","Bank Name","Bank A/C No.","IFSC Code","Designation","Current Address","Permanent Address","Blood Group","Attendance Device ID (Biometric/RF tag ID)","Qualification (Education)","School/University (Education)"],isLoading:!1,message:null,previewData:[],previewHeaders:[],classes:[],editHistory:[],pendingEdits:[]}},created(){this.fetchClasses(),this.debouncedSendCellUpdate=this.debounce(this.sendCellUpdate,500)},methods:{fetchClasses(){return w(this,null,function*(){try{const s=yield R({values:{}});console.log("getClasses API response:",s),s&&s.message&&Array.isArray(s.message)?(this.classes=s.message.map(e=>e.name).filter(e=>e),console.log("Processed classes:",this.classes)):(this.classes=[],console.warn("No valid classes found in response"),this.showMessage("No classes available","error"))}catch(s){console.error("Error fetching classes:",s),this.classes=[],this.showMessage("Error fetching classes: "+(s.message||"Unknown error"),"error")}})},onClassChange(s){return w(this,null,function*(){const e=this.previewData[s];if(e.divisionName=null,e.className)try{const l=yield G({values:{classId:e.className}});console.log("getDivisions1 API response:",l),e.divisions=l.message?l.message.map(c=>c.name).filter(c=>c):[],console.log(`Divisions for ${e.className}:`,e.divisions)}catch(l){console.error("Error fetching divisions:",l),this.showMessage(`Error fetching divisions for ${e.className}`,"error")}else e.divisions=[]})},getExcelColumnLetter(s){let e="";for(;s>=0;)e=String.fromCharCode(65+s%26)+e,s=Math.floor(s/26)-1;return e},handleFileSelection(){return w(this,null,function*(){const s=document.createElement("input");s.type="file",s.accept=".xlsx,.xls",s.onchange=e=>w(this,null,function*(){const l=e.target.files[0];if(l){this.fileSelected=l,this.showMessage(null);try{const{data:c,headers:t}=yield this.readExcelFile(l);this.previewData=c.slice(0,100).map(o=>M(S({},o),{className:null,divisionName:null,divisions:[]})),this.previewHeaders=t,this.mappings=t.map((o,a)=>({type:null,column:y.encode_col(a)})),this.autoDetectMappings(t,c.slice(0,5))}catch(c){console.error("Error loading preview:",c),this.showMessage("Error loading file preview","error")}}}),s.click()})},autoDetectMappings(s,e){const l={"First Name":["first","fname","given","firstname"],"Middle Name":["middle","mname","midname"],"Last Name":["last","lname","surname","family","lastname"],"Full Name":["full name","name","teacher name"],Email:["email","e-mail","mail"],Mobile:["mobile","phone","cell","contact"],"Date of Birth":["dob","birth","birthdate","date of birth"],Gender:["gender","sex"],"Date of Joining":["doj","joining","start date"],"PAN Number":["pan","pan no","pan number"],"Bank Name":["bank","bank name"],"Bank A/C No.":["account","ac no","bank account","account no"],"IFSC Code":["ifsc","code"],Designation:["designation","position","title","role"],"Current Address":["current address","address","present address"],"Permanent Address":["permanent address","home address"],"Blood Group":["blood","blood group"],"Attendance Device ID (Biometric/RF tag ID)":["attendance id","biometric","rfid","device id"],"Qualification (Education)":["qualification","education","degree"],"School/University (Education)":["school","university","institution"]};s.forEach((c,t)=>{if(!c)return;const o=c.toString().toLowerCase();for(const[a,r]of Object.entries(l))if(r.some(i=>o.includes(i))){this.mappings[t].type=a;break}}),console.log("Auto-detected mappings:",this.mappings)},removeFile(){this.fileSelected=null,this.previewData=[],this.previewHeaders=[],this.mappings=[],this.editHistory=[],this.pendingEdits=[],this.showMessage(null)},prepareTeachersData(s,e=null){let l=s;e!==null&&(l=[s[e]]);const c=[...this.previewData],o=l.map((a,r)=>{const i=e!==null?a:r<c.length?c[r]:{},h={"First Name":"","Middle Name":"","Last Name":"","Full Name":"",Gender:"",Mobile:"",Email:"","Date of Birth":"","Date of Joining":"","PAN Number":"","Bank Name":"","Bank A/C No.":"","IFSC Code":"",Designation:"","Current Address":"","Permanent Address":"","Blood Group":"","Attendance Device ID (Biometric/RF tag ID)":"","Qualification (Education)":"","School/University (Education)":"",Class:i.className||"",Division:i.divisionName||""};return this.mappings.forEach(({type:g,column:E},p)=>{var m;if(g)try{const v=y.decode_col(E),f=this.previewHeaders[v],N=((m=a[f])==null?void 0:m.toString().trim())||"";h[g]=N}catch(v){console.error(`Error mapping column ${E} for type ${g}:`,v)}}),h}).filter(a=>Object.values(a).some(r=>r!==""));return S({teachers:o},this.options.reduce((a,r)=>{const i=this.mappings.find(h=>h.type===r);return a[r]=i?i.column:"None",a},{}))},handleEnrollTeachers(){return w(this,null,function*(){console.log("Enroll button clicked");const s=["Mobile","Email","Date of Birth","Gender","First Name","Last Name","Attendance Device ID (Biometric/RF tag ID)"],e=this.mappings.map(t=>t.type).filter(t=>t),l=s.filter(t=>!e.includes(t));if(l.length>0){const t=`Please map the following required fields: ${l.join(", ")}`;console.error(t),this.showMessage(t,"error");return}if(this.mappings.filter(t=>t.type&&(!t.column||!/^[A-Z]+$/.test(t.column))).length>0){this.showMessage("Please check your column mappings - some are invalid","error");return}if(!this.fileSelected){const t="Please select a file first";console.error(t),this.showMessage(t,"error");return}this.isLoading=!0,this.showMessage(null);try{if(this.previewData.length===0)throw new Error("No data available to enroll");const t=this.prepareTeachersData(this.previewData);console.log("Sending updated preview data to enrollTeachers:",t);const o=yield T(t);o.success?(this.showMessage("✅ Teachers enrolled successfully!","success"),this.pendingEdits=[]):(this.showMessage(o.error||"Failed to enroll teachers","error"),console.error("Enrollment error details:",{error:o.error,duplicates:o.duplicates,message:o.message}))}catch(t){console.error("Error enrolling teachers:",t),this.showMessage(t.message||"Unexpected error during teacher enrollment","error")}finally{this.isLoading=!1}})},readExcelFile(s){return w(this,null,function*(){return new Promise((e,l)=>{const c=new FileReader;c.onload=t=>{try{const o=new Uint8Array(t.target.result),a=j(o,{type:"array",sheetStubs:!0}),r=a.Sheets[a.SheetNames[0]],i=y.decode_range(r["!ref"]);let h=0;for(let p=i.s.r;p<=i.e.r;++p){let m=!1;for(let v=i.s.c;v<=i.e.c;++v){const f=r[y.encode_cell({c:v,r:p})];if(f&&f.v!==void 0&&f.v!==null&&f.v!==""){m=!0;break}}if(m){h=p;break}}const g=[];for(let p=i.s.c;p<=i.e.c;++p){const m=r[y.encode_cell({c:p,r:h})];g.push(m?String(m.v).trim():`Column ${p+1}`)}const E=[];for(let p=h+1;p<=i.e.r;++p){const m={};let v=!1;for(let f=i.s.c;f<=i.e.c;++f){const N=r[y.encode_cell({c:f,r:p})],A=g[f-i.s.c];m[A]=N?N.v===void 0?"":N.v:"",m[A]!==""&&(v=!0)}v&&E.push(m)}e({data:E,headers:g})}catch(o){l(o)}},c.onerror=t=>l(t),c.readAsArrayBuffer(s)})})},updateMapping(s,e,l){this.$set(this.mappings,s,M(S({},this.mappings[s]),{[e]:l,column:y.encode_col(s)}))},deleteRow(s){this.previewData.splice(s,1),this.editHistory=this.editHistory.filter(e=>e.rowIndex!==s),this.pendingEdits=this.pendingEdits.filter(e=>e.rowIndex!==s),this.showMessage("Row deleted","success")},showMessage(s,e="info"){this.message=s?{text:s,type:e}:null,s&&e!=="error"&&e!=="success"&&setTimeout(()=>this.showMessage(null),5e3)},handleCellEdit(s,e,l){const t=this.previewData[s][e]||"";if(t!==l){const o={rowIndex:s,column:e,oldValue:t,newValue:l,timestamp:new Date().toISOString()};this.editHistory.push(o),this.pendingEdits.push(o),console.log("Cell edit recorded:",o),this.debouncedSendCellUpdate()}},debounce(s,e){let l;return function(...c){clearTimeout(l),l=setTimeout(()=>s.apply(this,c),e)}},sendCellUpdate(){return w(this,null,function*(){if(this.pendingEdits.length!==0){this.isLoading=!0;try{const s=this.pendingEdits[this.pendingEdits.length-1],e=this.prepareTeachersData(this.previewData,s.rowIndex);console.log("Sending cell update via enrollTeachers:",e);const l=yield T(e);l.success?(this.showMessage("Cell update saved successfully","success"),this.pendingEdits=[]):this.showMessage(l.error||"Failed to save cell update","error")}catch(s){console.error("Error sending cell update:",s),this.showMessage(`Failed to save cell update: ${s.message||"Unknown error"}`,"error")}finally{this.isLoading=!1}}})},undoLastEdit(){const s=this.editHistory.pop();if(s){const{rowIndex:e,column:l,oldValue:c}=s;this.previewData[e][l]=c,this.pendingEdits=this.pendingEdits.filter(t=>t!==s),this.showMessage("Last edit undone","success")}else this.showMessage("No edits to undo","info")}}},z={class:"scroll-view-content"},Z={class:"white-card"},K={key:0,class:"file-selected"},W={class:"button-text"},X={class:"white-card"},Y=["disabled"],$={key:0,class:"button-text"},ee={key:1,class:"button-text"},se={key:0,class:"table-white-card preview-card"},te={class:"table-outer-container"},ie={class:"table-scroll-container"},le={class:"table-container"},ne={class:"preview-table"},ae=["onUpdate:modelValue","onChange"],oe=["value"],re={class:"header-label"},ce={class:"actions"},de=["onClick"],ue=["onUpdate:modelValue","onChange"],he=["value"],pe=["onUpdate:modelValue","disabled"],me=["value"],ge=["onUpdate:modelValue","onInput","placeholder"];function fe(s,e,l,c,t,o){return u(),d("div",z,[e[16]||(e[16]=n("h1",{class:"title"},"Teacher Enrollment",-1)),n("div",Z,[e[3]||(e[3]=n("h2",{class:"card-title"},"Upload Teacher Data",-1)),t.fileSelected?(u(),d("div",K,[n("span",null,"Selected file: "+b(t.fileSelected.name),1),n("button",{onClick:e[0]||(e[0]=(...a)=>o.removeFile&&o.removeFile(...a)),class:"remove-file-btn"},"×")])):F("",!0),n("button",{class:"button",onClick:e[1]||(e[1]=(...a)=>o.handleFileSelection&&o.handleFileSelection(...a))},[n("span",W,b(t.fileSelected?"Change File":"Upload File 📤"),1)])]),n("div",X,[n("button",{class:"button",onClick:e[2]||(e[2]=(...a)=>o.handleEnrollTeachers&&o.handleEnrollTeachers(...a)),disabled:t.isLoading||!t.fileSelected},[t.isLoading?(u(),d("span",$,e[4]||(e[4]=[n("span",{class:"spinner"},null,-1),q(" Processing... ")]))):(u(),d("span",ee,"Enroll Teachers ✅"))],8,Y),t.message?(u(),d("div",{key:0,class:J(["message",t.message.type])},b(t.message.text),3)):F("",!0)]),t.fileSelected&&t.previewData.length>0?(u(),d("div",se,[e[15]||(e[15]=n("h2",{class:"card-title"},"File Preview (First 100 rows)",-1)),n("div",te,[n("div",ie,[n("div",le,[n("table",ne,[n("thead",null,[n("tr",null,[e[5]||(e[5]=n("th",{class:"actions"},"Actions",-1)),e[6]||(e[6]=n("th",null,"Class/Program",-1)),e[7]||(e[7]=n("th",null,"Division/Student Group",-1)),(u(!0),d(D,null,C(t.previewHeaders,(a,r)=>(u(),d("th",{key:"letter-"+r},b(o.getExcelColumnLetter(r)),1))),128))]),n("tr",null,[e[9]||(e[9]=n("th",{class:"actions"},null,-1)),e[10]||(e[10]=n("th",null,"Class/Program",-1)),e[11]||(e[11]=n("th",null,"Division/Student Group",-1)),(u(!0),d(D,null,C(t.previewHeaders,(a,r)=>(u(),d("th",{key:"header-"+r},[k(n("select",{"onUpdate:modelValue":i=>t.mappings[r].type=i,class:"table-select",onChange:i=>o.updateMapping(r,"type",i.target.value)},[e[8]||(e[8]=n("option",{value:null},"Select Field",-1)),(u(!0),d(D,null,C(t.options,(i,h)=>(u(),d("option",{key:h,value:i},b(i),9,oe))),128))],40,ae),[[_,t.mappings[r].type]]),n("span",re,b(a),1)]))),128))])]),n("tbody",null,[(u(!0),d(D,null,C(t.previewData,(a,r)=>(u(),d("tr",{key:r},[n("td",ce,[n("button",{onClick:i=>o.deleteRow(r),class:"trash-icon2"},e[12]||(e[12]=[n("span",{class:"icon"},"❎",-1)]),8,de)]),n("td",null,[k(n("select",{"onUpdate:modelValue":i=>a.className=i,class:"table-select",onChange:i=>o.onClassChange(r)},[e[13]||(e[13]=n("option",{value:null},"Select Class",-1)),(u(!0),d(D,null,C(t.classes,i=>(u(),d("option",{key:i,value:i},b(i),9,he))),128))],40,ue),[[_,a.className]])]),n("td",null,[k(n("select",{"onUpdate:modelValue":i=>a.divisionName=i,class:"table-select",disabled:!a.className},[e[14]||(e[14]=n("option",{value:null},"Select Division",-1)),(u(!0),d(D,null,C(a.divisions,i=>(u(),d("option",{key:i,value:i},b(i),9,me))),128))],8,pe),[[_,a.divisionName]])]),(u(!0),d(D,null,C(t.previewHeaders,(i,h)=>(u(),d("td",{key:h},[k(n("input",{"onUpdate:modelValue":g=>a[i]=g,class:"table-input",onInput:g=>o.handleCellEdit(r,i,g.target.value),placeholder:a[i]||"-"},null,40,ge),[[O,a[i]]])]))),128))]))),128))])])])])])])):F("",!0)])}const De=x(Q,[["render",fe],["__scopeId","data-v-9ad83a83"]]);export{De as default};
