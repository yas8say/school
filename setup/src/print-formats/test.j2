<style>
    @page {
        size: A3 landscape;
        margin: 0.2cm;
    }

    body {
        font-family: Arial, sans-serif;
        font-size: 9px;
        color: #222;
        line-height: 1;
        margin: 0;
        padding: 0;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .receipt-container {
        display: flex;
        justify-content: space-between;
        page-break-inside: avoid;
        width: 100%;
        height: 100%;
    }

    .receipt {
        width: 49%;
        border: 0.5px solid #ccc;
        padding: 2px;
        page-break-inside: avoid;
        height: 100%;
        box-sizing: border-box;
    }

    h2, h3 {
        margin: 1px 0;
        padding: 0;
        line-height: 1;
    }

    .section {
        margin-bottom: 1px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1px;
    }

    th, td {
        border: 0.5px solid #ccc;
        padding: 0.3px;
        vertical-align: top;
        line-height: 1;
    }

    th {
        background: #f2f2f2;
        padding: 0.3px;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.3px;
    }

    .items-table td, .items-table th {
        padding: 0.2px;
        border: 0.3px solid #ddd;
        line-height: 1;
    }

    .summary-box {
        margin-top: 1px;
        padding: 1px;
        background: #f8f8f8;
        border: 0.5px solid #ddd;
    }

    .header-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1px;
        border-bottom: 1px solid #333;
        padding-bottom: 1px;
    }

    .company-header {
        text-align: center;
        flex-grow: 1;
    }

    .item-name {
        font-weight: bold;
    }

    .compact-row {
        height: 6px;
    }

    .items-row {
        height: 4px;
    }

    .highlight {
        background: #f8f9fa;
    }

    /* Remove all portrait-specific styles and mobile styles */
    @media (max-width: 768px) {
        .receipt-container {
            flex-direction: column;
        }
        .receipt {
            width: 100%;
            margin-bottom: 10px;
        }
    }

    @media print {
        @page {
            size: A3 landscape;
            margin: 0.2cm;
        }
        
        body {
            margin: 0;
            padding: 0;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .receipt-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            height: 100%;
        }
        
        .receipt {
            width: 49%;
            height: 100%;
            page-break-inside: avoid;
        }
        
        /* Ensure no page breaks inside receipts */
        .receipt {
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        /* Hide unnecessary elements during print */
        .no-print {
            display: none !important;
        }
    }

    /* Force landscape layout for all screen sizes */
    @media screen {
        body {
            width: 42cm;   /* A3 landscape width */
            height: 29.7cm; /* A3 landscape height */
            margin: 0 auto;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .receipt-container {
            min-height: 28.7cm; /* Adjusted for A3 */
        }
    }
</style>

<!-- METHOD: Find student by customer name -->
{% set student_data = None %}
{% set student_group_data = None %}
{% set student_roll_no = None %}
{% set customer_name = doc.party %}

<!-- Try to find student by matching customer name with student name -->
{% if customer_name %}
    {% set students = frappe.get_all("Student", 
        filters={
            "student_name": ["like", "%" + customer_name + "%"]
        },
        fields=["name", "student_name", "gr_number"]
    ) %}
    
    {% if students and students|length > 0 %}
        {% set student_data = frappe.get_doc("Student", students[0].name) %}
        
        <!-- Find student group and roll number -->
        {% set student_groups = frappe.get_all("Student Group Student", 
            filters={"student": student_data.name},
            fields=["parent", "group_roll_number"]
        ) %}
        
        {% if student_groups and student_groups|length > 0 %}
            {% set student_group_data = frappe.get_doc("Student Group", student_groups[0].parent) %}
            {% set student_roll_no = student_groups[0].group_roll_number %}
        {% endif %}
    {% else %}
        <!-- If no direct match, try partial matching -->
        {% set all_students = frappe.get_all("Student", 
            fields=["name", "student_name", "gr_number"]
        ) %}
        
        {% set found_student = None %}
        {% for student in all_students %}
            {% if customer_name.lower() in (student.student_name or "").lower() %}
                {% set found_student = student %}
            {% endif %}
        {% endfor %}
        
        {% if found_student %}
            {% set student_data = frappe.get_doc("Student", found_student.name) %}
            
            <!-- Find student group and roll number -->
            {% set student_groups = frappe.get_all("Student Group Student", 
                filters={"student": student_data.name},
                fields=["parent", "group_roll_number"]
            ) %}
            
            {% if student_groups and student_groups|length > 0 %}
                {% set student_group_data = frappe.get_doc("Student Group", student_groups[0].parent) %}
                {% set student_roll_no = student_groups[0].group_roll_number %}
            {% endif %}
        {% endif %}
    {% endif %}
{% endif %}

<div class="receipt-container">
    <!-- FIRST RECEIPT (FOR SCHOOL) -->
    <div class="receipt">
        <div class="header-info">
            <div class="company-header">
                <h2 style="margin: 0.5px 0; font-size: 12px; font-weight: bold;">{{ frappe.db.get_value("Company", doc.company, "company_name") }}</h2>
                <div style="font-size: 7px;">Payment Receipt (School Copy)</div>
            </div>
            <div class="document-info" style="text-align: right;">
                <h2 style="margin: 0.5px 0; font-size: 9px; font-weight: bold;">{{ doc.name }}</h2>
                <div style="font-size: 7px;">
                    <strong>Date:</strong> {{ doc.posting_date }} 
                    {% if doc.reference_no %}<br><strong>Ref:</strong> {{ doc.reference_no }}{% endif %}
                </div>
            </div>
        </div>

        <!-- MERGED PAYMENT & STUDENT DETAILS -->
        <div class="section">
            <h3 style="margin: 1px 0; font-size: 9px; border-bottom: 0.5px solid #333; padding-bottom: 0.5px;">Payment & Student Details</h3>
            <table>
                <tr class="compact-row highlight">
                    <td width="20%"><strong>Type:</strong> {{ doc.payment_type }}</td>
                    <td width="20%"><strong>Mode:</strong> {{ doc.mode_of_payment }}</td>
                    <td width="20%"><strong>Amount:</strong> {{ doc.get_formatted("paid_amount") }}</td>
                    {% if student_data %}
                    <td width="20%"><strong>Student ID:</strong> {{ student_data.name }}</td>
                    <td width="20%"><strong>GR No:</strong> {{ student_data.gr_number or "N/A" }}</td>
                    {% else %}
                    <td width="40%" colspan="2"><strong>Customer:</strong> {{ customer_name }}</td>
                    {% endif %}
                </tr>
                {% if student_data %}
                <tr class="compact-row">
                    <td colspan="2"><strong>Student Name:</strong> {{ student_data.student_name or "N/A" }}</td>
                    <td><strong>Group:</strong> {{ student_group_data.student_group_name if student_group_data else "N/A" }}</td>
                    <td><strong>Roll No:</strong> {{ student_roll_no or "N/A" }}</td>
                    <td><strong>Academic Year:</strong> {{ student_group_data.academic_year if student_group_data else "N/A" }}</td>
                </tr>
                {% endif %}
            </table>
        </div>

        <!-- INVOICES TABLE -->
        <h3 style="margin: 1px 0; font-size: 9px; border-bottom: 0.5px solid #333; padding-bottom: 0.5px;">Paid Invoices</h3>
        <table>
            <thead>
                <tr class="compact-row" style="background: #f2f2f2;">
                    <th width="15%">Invoice</th>
                    <th width="10%">Date</th>
                    <th width="15%">Total</th>
                    <th width="15%">Paid</th>
                    <th width="45%">Items</th>
                </tr>
            </thead>
            <tbody>
                {% for ref in doc.references %}
                    {% if ref.reference_doctype == "Sales Invoice" %}
                        {% set inv = frappe.get_doc("Sales Invoice", ref.reference_name) %}
                        <tr class="compact-row" style="background: {% if loop.index % 2 == 0 %}#f8f9fa{% else %}#ffffff{% endif %};">
                            <td><strong>{{ inv.name }}</strong></td>
                            <td>{{ inv.posting_date }}</td>
                            <td>{{ frappe.format_value(inv.grand_total, {'fieldtype': 'Currency'}) }}</td>
                            <td><strong>{{ frappe.format_value(ref.allocated_amount, {'fieldtype': 'Currency'}) }}</strong></td>
                            <td>
                                <table class="items-table">
                                    <tbody>
                                        {% for item in inv.items %}
                                        <tr class="items-row" style="background: {% if loop.index % 2 == 0 %}#f8f9fa{% else %}#ffffff{% endif %};">
                                            <td class="item-name" width="70%">{{ item.item_name or item.item_code }}</td>
                                            <td width="30%">{{ frappe.format_value(item.amount, {'fieldtype': 'Currency'}) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>

        <!-- SUMMARY -->
        <div class="summary-box">
            <h3 style="margin: 1px 0; font-size: 9px;">Payment Summary</h3>
            <table>
                <tr class="compact-row">
                    <td width="30%"><strong>Total Invoices:</strong> {{ doc.references|length }}</td>
                    <td width="70%"><strong>Total Paid:</strong> {{ doc.get_formatted("total_allocated_amount") }}</td>
                </tr>
                <tr class="compact-row">
                    <td colspan="2"><strong>In Words:</strong> {{ doc.in_words or doc.base_in_words }}</td>
                </tr>
            </table>
        </div>

        <!-- SIGNATURE -->
        <div style="margin-top: 2px; padding-top: 1px; border-top: 1px solid #333;">
            <div style="text-align: center; line-height: 1;">
                <p style="margin: 0.3px 0; font-size: 8px;"><strong>_________________________</strong></p>
                <p style="margin: 0.3px 0; font-size: 7px;"><strong>Authorized Signature</strong></p>
                <p style="margin: 0.3px 0; font-size: 6px;">{{ frappe.db.get_value("Company", doc.company, "company_name") }}</p>
            </div>
        </div>
    </div>

    <!-- SECOND RECEIPT (FOR PARENT) -->
    <div class="receipt">
        <div class="header-info">
            <div class="company-header">
                <h2 style="margin: 0.5px 0; font-size: 12px; font-weight: bold;">{{ frappe.db.get_value("Company", doc.company, "company_name") }}</h2>
                <div style="font-size: 7px;">Payment Receipt (Parent Copy)</div>
            </div>
            <div class="document-info" style="text-align: right;">
                <h2 style="margin: 0.5px 0; font-size: 9px; font-weight: bold;">{{ doc.name }}</h2>
                <div style="font-size: 7px;">
                    <strong>Date:</strong> {{ doc.posting_date }} 
                    {% if doc.reference_no %}<br><strong>Ref:</strong> {{ doc.reference_no }}{% endif %}
                </div>
            </div>
        </div>

        <!-- MERGED PAYMENT & STUDENT DETAILS -->
        <div class="section">
            <h3 style="margin: 1px 0; font-size: 9px; border-bottom: 0.5px solid #333; padding-bottom: 0.5px;">Payment & Student Details</h3>
            <table>
                <tr class="compact-row highlight">
                    <td width="20%"><strong>Type:</strong> {{ doc.payment_type }}</td>
                    <td width="20%"><strong>Mode:</strong> {{ doc.mode_of_payment }}</td>
                    <td width="20%"><strong>Amount:</strong> {{ doc.get_formatted("paid_amount") }}</td>
                    {% if student_data %}
                    <td width="20%"><strong>Student ID:</strong> {{ student_data.name }}</td>
                    <td width="20%"><strong>GR No:</strong> {{ student_data.gr_number or "N/A" }}</td>
                    {% else %}
                    <td width="40%" colspan="2"><strong>Customer:</strong> {{ customer_name }}</td>
                    {% endif %}
                </tr>
                {% if student_data %}
                <tr class="compact-row">
                    <td colspan="2"><strong>Student Name:</strong> {{ student_data.student_name or "N/A" }}</td>
                    <td><strong>Group:</strong> {{ student_group_data.student_group_name if student_group_data else "N/A" }}</td>
                    <td><strong>Roll No:</strong> {{ student_roll_no or "N/A" }}</td>
                    <td><strong>Academic Year:</strong> {{ student_group_data.academic_year if student_group_data else "N/A" }}</td>
                </tr>
                {% endif %}
            </table>
        </div>

        <!-- INVOICES TABLE -->
        <h3 style="margin: 1px 0; font-size: 9px; border-bottom: 0.5px solid #333; padding-bottom: 0.5px;">Paid Invoices</h3>
        <table>
            <thead>
                <tr class="compact-row" style="background: #f2f2f2;">
                    <th width="15%">Invoice</th>
                    <th width="10%">Date</th>
                    <th width="15%">Total</th>
                    <th width="15%">Paid</th>
                    <th width="45%">Items</th>
                </tr>
            </thead>
            <tbody>
                {% for ref in doc.references %}
                    {% if ref.reference_doctype == "Sales Invoice" %}
                        {% set inv = frappe.get_doc("Sales Invoice", ref.reference_name) %}
                        <tr class="compact-row" style="background: {% if loop.index % 2 == 0 %}#f8f9fa{% else %}#ffffff{% endif %};">
                            <td><strong>{{ inv.name }}</strong></td>
                            <td>{{ inv.posting_date }}</td>
                            <td>{{ frappe.format_value(inv.grand_total, {'fieldtype': 'Currency'}) }}</td>
                            <td><strong>{{ frappe.format_value(ref.allocated_amount, {'fieldtype': 'Currency'}) }}</strong></td>
                            <td>
                                <table class="items-table">
                                    <tbody>
                                        {% for item in inv.items %}
                                        <tr class="items-row" style="background: {% if loop.index % 2 == 0 %}#f8f9fa{% else %}#ffffff{% endif %};">
                                            <td class="item-name" width="70%">{{ item.item_name or item.item_code }}</td>
                                            <td width="30%">{{ frappe.format_value(item.amount, {'fieldtype': 'Currency'}) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>

        <!-- SUMMARY -->
        <div class="summary-box">
            <h3 style="margin: 1px 0; font-size: 9px;">Payment Summary</h3>
            <table>
                <tr class="compact-row">
                    <td width="30%"><strong>Total Invoices:</strong> {{ doc.references|length }}</td>
                    <td width="70%"><strong>Total Paid:</strong> {{ doc.get_formatted("total_allocated_amount") }}</td>
                </tr>
                <tr class="compact-row">
                    <td colspan="2"><strong>In Words:</strong> {{ doc.in_words or doc.base_in_words }}</td>
                </tr>
            </table>
        </div>

        <!-- SIGNATURE -->
        <div style="margin-top: 2px; padding-top: 1px; border-top: 1px solid #333;">
            <div style="text-align: center; line-height: 1;">
                <p style="margin: 0.3px 0; font-size: 8px;"><strong>_________________________</strong></p>
                <p style="margin: 0.3px 0; font-size: 7px;"><strong>Authorized Signature</strong></p>
                <p style="margin: 0.3px 0; font-size: 6px;">{{ frappe.db.get_value("Company", doc.company, "company_name") }}</p>
            </div>
        </div>
    </div>
</div>